<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Configuration - LMS MCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 60% - Neutral/Background Colors */
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            
            /* 30% - Primary Content Colors */
            --primary: 222.2 84% 4.9%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            
            /* 10% - Accent/Action Colors */
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --success: 142.1 76.2% 36.3%;
            --success-foreground: 355.7 100% 97.3%;
            --warning: 47.9 95.8% 53.1%;
            --warning-foreground: 26 83.3% 14.1%;
            
            --radius: 0.75rem;
        }
        
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 94.1%;
        }
        
        * {
            border-color: hsl(var(--border));
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        /* Shadcn-style button variants */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: colors 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            padding: 0.625rem 1rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .btn-primary:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px hsl(var(--ring));
        }
        
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: colors 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            padding: 0.625rem 1rem;
            border: 1px solid hsl(var(--border));
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }
        
        .btn-destructive {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: colors 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
            padding: 0.625rem 1rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-destructive:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }

        .btn-success {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: colors 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: hsl(var(--success));
            color: hsl(var(--success-foreground));
            padding: 0.625rem 1rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-success:hover {
            background-color: hsl(var(--success) / 0.9);
        }

        /* Button disabled state */
        .btn-primary:disabled,
        .btn-secondary:disabled,
        .btn-destructive:disabled,
        .btn-success:disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Shadcn-style card */
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.2s ease-in-out;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Shadcn-style badge */
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            border: 1px solid transparent;
            padding: 0.125rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: colors 0.2s ease-in-out;
        }
        
        .badge-default {
            border-color: transparent;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .badge-secondary {
            border-color: transparent;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .badge-success {
            border-color: transparent;
            background-color: hsl(var(--success));
            color: hsl(var(--success-foreground));
        }
        
        .badge-destructive {
            border-color: transparent;
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        /* Shadcn-style input */
        .input {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--input));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: colors 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .input::placeholder {
            color: hsl(var(--muted-foreground));
        }
        
        .input:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px hsl(var(--ring));
        }

        /* Service status indicators */
        .status-running {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-stopped {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: #ef4444;
        }
        
        .status-unknown {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: #6b7280;
        }

        /* Custom animations */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: ["class"],
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))"
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))"
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))"
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))"
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))"
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))"
                        }
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)"
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-background">
    <!-- Main Layout Container -->
    <div class="min-h-full">
        <!-- Header - 10% Accent -->
        <header class="bg-card border-b border-border shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 py-6">
                    <div class="fade-in">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                                <i data-lucide="settings" class="w-6 h-6 text-primary-foreground"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-foreground">Configuration Management</h1>
                                <p class="text-sm text-muted-foreground">Manage system configuration settings</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons - 10% Accent -->
                    <div class="flex flex-wrap gap-3 fade-in">
                        <button onclick="validateConfiguration()" class="btn-primary gap-2">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            Validate
                        </button>
                        <button onclick="createBackup()" class="btn-secondary gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Backup
                        </button>
                        <button onclick="saveConfiguration()" class="btn-success gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            Save All
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area - 60% Background + 30% Primary Content -->
        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <!-- Navigation Tabs -->
            <div class="mb-8">
                <div class="border-b border-border">
                    <nav class="flex space-x-8 overflow-x-auto" id="config-tabs">
                        <!-- Tabs will be generated here -->
                    </nav>
                </div>
            </div>

            <!-- Tab Content Container -->
            <div id="tab-content" class="fade-in">
                <!-- Content will be generated here -->
            </div>
        </main>
    </div>

    <!-- Toast Container - Fixed positioning -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        let currentConfig = {};
        let servicesStatus = {};
        let activeTab = 'overview';

        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            loadServicesStatus();
        });

        async function loadConfiguration() {
            try {
                const response = await fetch('/admin/api/config');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                currentConfig = data.config;
                renderConfiguration();
            } catch (error) {
                showToast(`Failed to load configuration: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadServicesStatus() {
            try {
                const response = await fetch('/admin/api/services/status');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                servicesStatus = data.services;
                if (activeTab === 'overview') {
                    renderTabContent();
                }
            } catch (error) {
                showToast(`Failed to load services status: ${error.message}`, 'error');
            }
        }

        function renderConfiguration() {
            renderTabs();
            renderTabContent();
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('config-tabs');
            tabsContainer.innerHTML = '';

            // Add Overview tab first
            const overviewTab = document.createElement('button');
            overviewTab.className = `relative py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200 flex items-center gap-2 ${
                activeTab === 'overview' 
                    ? 'border-primary text-primary font-semibold' 
                    : 'border-transparent text-muted-foreground hover:text-foreground hover:border-border'
            }`;
            overviewTab.innerHTML = `
                <i data-lucide="activity" class="w-4 h-4"></i>
                Overview
            `;
            overviewTab.onclick = () => switchTab('overview');
            tabsContainer.appendChild(overviewTab);

            // Add configuration tabs
            Object.keys(currentConfig).forEach(categoryId => {
                const category = currentConfig[categoryId];
                const tab = document.createElement('button');
                tab.className = `relative py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200 flex items-center gap-2 ${
                    activeTab === categoryId 
                        ? 'border-primary text-primary font-semibold' 
                        : 'border-transparent text-muted-foreground hover:text-foreground hover:border-border'
                }`;
                
                // Add appropriate icon based on category
                const getIcon = (categoryId) => {
                    switch(categoryId) {
                        case 'database': return 'database';
                        case 'telegram': return 'message-circle';
                        case 'security': return 'shield';
                        case 'api': return 'globe';
                        default: return 'settings';
                    }
                };
                
                tab.innerHTML = `
                    <i data-lucide="${getIcon(categoryId)}" class="w-4 h-4"></i>
                    ${category.name}
                `;
                tab.onclick = () => switchTab(categoryId);
                tabsContainer.appendChild(tab);
            });
            
            // Initialize Lucide icons for tabs
            setTimeout(() => lucide.createIcons(), 100);
        }

        function switchTab(categoryId) {
            activeTab = categoryId;
            renderConfiguration();
        }

        function renderTabContent() {
            const contentContainer = document.getElementById('tab-content');
            contentContainer.innerHTML = '';

            if (activeTab === 'overview') {
                renderOverviewContent(contentContainer);
                return;
            }

            if (!currentConfig[activeTab]) {
                return;
            }

            const category = currentConfig[activeTab];
            
            // Category header with improved design
            const header = document.createElement('div');
            header.className = 'mb-8 fade-in';
            header.innerHTML = `
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-foreground mb-2">${category.name}</h2>
                    <p class="text-muted-foreground">${category.description}</p>
                </div>
            `;
            contentContainer.appendChild(header);

            // Variables grid with improved responsive design
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 gap-6 sm:grid-cols-2 xl:grid-cols-3 fade-in';

            Object.entries(category.variables).forEach(([varName, varConfig]) => {
                const card = createVariableCard(activeTab, varName, varConfig);
                grid.appendChild(card);
            });

            contentContainer.appendChild(grid);
        }

        function createVariableCard(categoryId, varName, varConfig) {
            const card = document.createElement('div');
            card.className = 'card p-6 space-y-4 hover:shadow-lg transition-all duration-200';

            const isRequired = varConfig.required;
            const inputType = getInputType(varConfig.type);
            const currentValue = varConfig.current_value || '';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="font-medium text-foreground mb-1">${varName}</h3>
                        <p class="text-sm text-muted-foreground">${varConfig.description}</p>
                    </div>
                    ${isRequired ? '<span class="badge badge-destructive ml-2 text-xs">Required</span>' : ''}
                </div>
                
                <div class="space-y-3">
                    ${createInput(categoryId, varName, varConfig, currentValue, inputType)}
                    ${varConfig.validation ? createValidationHint(varConfig.validation) : ''}
                </div>
            `;

            return card;
        }

        function getInputType(configType) {
            switch(configType) {
                case 'password': return 'password';
                case 'number': return 'number';
                case 'boolean': return 'checkbox';
                case 'url': return 'url';
                default: return 'text';
            }
        }

        function createInput(categoryId, varName, varConfig, currentValue, inputType) {
            const inputId = `${categoryId}_${varName}`;
            
            if (inputType === 'checkbox') {
                const checked = currentValue === 'true' ? 'checked' : '';
                return `
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <input type="checkbox" id="${inputId}" name="${varName}" ${checked} 
                                   onchange="updateConfigValue('${categoryId}', '${varName}', this.checked.toString())"
                                   class="w-4 h-4 text-primary bg-background border-border rounded focus:ring-primary focus:ring-2 transition-colors">
                        </div>
                        <label for="${inputId}" class="text-sm font-medium text-foreground cursor-pointer">Enabled</label>
                    </div>
                `;
            } else {
                const step = varConfig.validation?.step ? `step="${varConfig.validation.step}"` : '';
                const min = varConfig.validation?.min ? `min="${varConfig.validation.min}"` : '';
                const max = varConfig.validation?.max ? `max="${varConfig.validation.max}"` : '';
                
                return `
                    <input type="${inputType}" id="${inputId}" name="${varName}" value="${currentValue}"
                           ${step} ${min} ${max}
                           onchange="updateConfigValue('${categoryId}', '${varName}', this.value)"
                           class="input w-full"
                           placeholder="Enter ${varName.toLowerCase()}...">
                `;
            }
        }

        function createValidationHint(validation) {
            const hints = [];
            if (validation.min_length) hints.push(`Min length: ${validation.min_length}`);
            if (validation.min) hints.push(`Min: ${validation.min}`);
            if (validation.max) hints.push(`Max: ${validation.max}`);
            if (validation.pattern) hints.push('Must match required format');
            
            return hints.length > 0 ? 
                `<div class="flex items-center gap-2 text-xs text-muted-foreground">
                    <i data-lucide="info" class="w-3 h-3"></i>
                    <span>${hints.join(', ')}</span>
                </div>` : '';
        }

        function updateConfigValue(categoryId, varName, value) {
            if (!currentConfig[categoryId]) {
                currentConfig[categoryId] = { variables: {} };
            }
            if (!currentConfig[categoryId].variables) {
                currentConfig[categoryId].variables = {};
            }
            if (!currentConfig[categoryId].variables[varName]) {
                currentConfig[categoryId].variables[varName] = {};
            }
            
            currentConfig[categoryId].variables[varName].current_value = value;
        }

        async function saveConfiguration() {
            try {
                const configToSave = {};
                
                Object.keys(currentConfig).forEach(categoryId => {
                    configToSave[categoryId] = {};
                    const category = currentConfig[categoryId];
                    
                    if (category.variables) {
                        Object.keys(category.variables).forEach(varName => {
                            const variable = category.variables[varName];
                            configToSave[categoryId][varName] = variable.current_value;
                        });
                    }
                });

                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ config: configToSave })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Configuration saved successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to save configuration');
                }
            } catch (error) {
                showToast(`Failed to save configuration: ${error.message}`, 'error');
            }
        }

        async function validateConfiguration() {
            try {
                const response = await fetch('/admin/api/validate');
                const data = await response.json();

                if (data.success) {
                    let errorCount = 0;
                    Object.values(data.validation).forEach(category => {
                        Object.values(category).forEach(variable => {
                            if (!variable.valid) {
                                errorCount += variable.errors.length;
                            }
                        });
                    });

                    if (errorCount === 0) {
                        showToast('Configuration validation passed!', 'success');
                    } else {
                        showToast(`Configuration has ${errorCount} validation errors`, 'error');
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showToast(`Validation failed: ${error.message}`, 'error');
            }
        }

        async function createBackup() {
            try {
                const response = await fetch('/admin/api/backup', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Configuration backup created successfully!', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showToast(`Backup failed: ${error.message}`, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            
            // Modern shadcn-style toast with appropriate colors
            let bgColorClass, textColorClass, iconName;
            switch(type) {
                case 'success':
                    bgColorClass = 'bg-success';
                    textColorClass = 'text-success-foreground';
                    iconName = 'check-circle';
                    break;
                case 'error':
                    bgColorClass = 'bg-destructive';
                    textColorClass = 'text-destructive-foreground';
                    iconName = 'x-circle';
                    break;
                default:
                    bgColorClass = 'bg-primary';
                    textColorClass = 'text-primary-foreground';
                    iconName = 'info';
                    break;
            }
            
            toast.className = `${bgColorClass} ${textColorClass} px-4 py-3 rounded-lg shadow-lg border border-border/20 backdrop-blur-sm transition-all duration-300 transform translate-x-full flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <i data-lucide="${iconName}" class="w-4 h-4 flex-shrink-0"></i>
                <span class="text-sm font-medium">${message}</span>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Initialize icon
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // Service status and control functions
        function renderOverviewContent(container) {
            container.innerHTML = `
                <div class="space-y-8">
                    <!-- System Status Header -->
                    <div class="card p-6 fade-in">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                                <i data-lucide="monitor" class="w-5 h-5 text-primary"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-foreground">System Overview</h2>
                                <p class="text-sm text-muted-foreground">Monitor and control system services</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-muted/50 rounded-lg">
                                <div class="text-2xl font-bold text-foreground">2</div>
                                <div class="text-sm text-muted-foreground">Services</div>
                            </div>
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-2xl font-bold text-success">Live</div>
                                <div class="text-sm text-muted-foreground">Monitoring</div>
                            </div>
                            <div class="text-center p-4 bg-primary/10 rounded-lg">
                                <div class="text-2xl font-bold text-primary">Active</div>
                                <div class="text-sm text-muted-foreground">Configuration</div>
                            </div>
                            <div class="text-center p-4 bg-warning/10 rounded-lg">
                                <div class="text-sm font-medium text-warning" id="last-updated">-</div>
                                <div class="text-sm text-muted-foreground">Last Updated</div>
                            </div>
                        </div>
                    </div>

                    <!-- Services Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Wazuh Realtime Server Card -->
                        <div class="card p-6 fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
                                        <i data-lucide="shield" class="w-5 h-5 text-blue-500"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-foreground">Wazuh Realtime Server</h3>
                                        <p class="text-sm text-muted-foreground">Security monitoring service</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div id="wazuh-status-indicator" class="status-unknown"></div>
                                    <span id="wazuh-status-text" class="text-sm font-medium text-muted-foreground">Unknown</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-sm text-muted-foreground">
                                    Monitors security events and provides real-time alerting capabilities.
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="start-wazuh-btn" onclick="controlService('wazuh_realtime', 'start')" 
                                            class="btn-success text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="play" class="w-3 h-3"></i>Start
                                    </button>
                                    <button id="stop-wazuh-btn" onclick="controlService('wazuh_realtime', 'stop')" 
                                            class="btn-destructive text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="stop" class="w-3 h-3"></i>Stop
                                    </button>
                                    <button id="restart-wazuh-btn" onclick="controlService('wazuh_realtime', 'restart')" 
                                            class="btn-secondary text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>Restart
                                    </button>
                                    <button onclick="viewServiceLogs('wazuh_realtime')" 
                                            class="btn-secondary text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="file-text" class="w-3 h-3"></i>Logs
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Telegram Bot Card -->
                        <div class="card p-6 fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-500/10 rounded-lg flex items-center justify-center">
                                        <i data-lucide="message-circle" class="w-5 h-5 text-green-500"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-foreground">Telegram Bot</h3>
                                        <p class="text-sm text-muted-foreground">Notification and reporting bot</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div id="telegram-status-indicator" class="status-unknown"></div>
                                    <span id="telegram-status-text" class="text-sm font-medium text-muted-foreground">Unknown</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-sm text-muted-foreground">
                                    Provides automated reporting and notification services via Telegram.
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="start-telegram-btn" onclick="controlService('telegram_bot', 'start')" 
                                            class="btn-success text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="play" class="w-3 h-3"></i>Start
                                    </button>
                                    <button id="stop-telegram-btn" onclick="controlService('telegram_bot', 'stop')" 
                                            class="btn-destructive text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="stop" class="w-3 h-3"></i>Stop
                                    </button>
                                    <button id="restart-telegram-btn" onclick="controlService('telegram_bot', 'restart')" 
                                            class="btn-secondary text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>Restart
                                    </button>
                                    <button onclick="viewServiceLogs('telegram_bot')" 
                                            class="btn-secondary text-xs px-3 py-1.5 gap-1">
                                        <i data-lucide="file-text" class="w-3 h-3"></i>Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize Lucide icons and load services status
            setTimeout(() => {
                lucide.createIcons();
                loadServicesStatus();
            }, 100);
        }

        async function controlService(service, action) {
            try {
                console.log(`Controlling service: ${service} -> ${action}`);
                
                const response = await fetch(`/admin/api/services/${service}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log(`Service control response:`, result);
                
                if (result.success) {
                    showToast(`${service} service ${action}ed successfully`, 'success');
                    // Refresh service status after 2 seconds
                    setTimeout(loadServicesStatus, 2000);
                } else {
                    showToast(`Failed to ${action} ${service} service: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error(`Error controlling ${service} service:`, error);
                showToast(`Error controlling ${service} service`, 'error');
            }
        }

        function loadServicesStatus() {
            fetch('/admin/api/services/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update service status indicators
                        const wazuhStatus = data.services.wazuh_realtime?.running ? 'running' : 'stopped';
                        const telegramStatus = data.services.telegram_bot?.running ? 'running' : 'stopped';
                        
                        updateServiceStatus('wazuh_realtime', wazuhStatus);
                        updateServiceStatus('telegram_bot', telegramStatus);
                        
                        // Update last updated timestamp
                        const lastUpdated = document.getElementById('last-updated');
                        if (lastUpdated) {
                            lastUpdated.textContent = new Date().toLocaleTimeString();
                        }
                        
                        // Debug log
                        console.log('Services status loaded:', {
                            wazuh: wazuhStatus,
                            telegram: telegramStatus,
                            raw_data: data.services
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading services status:', error);
                });
        }

        function updateServiceStatus(service, status) {
            // Map service names to UI element names
            const serviceMap = {
                'wazuh_realtime': 'wazuh',
                'telegram_bot': 'telegram'
            };
            
            const uiServiceName = serviceMap[service] || service;
            
            const statusIndicator = document.getElementById(`${uiServiceName}-status-indicator`);
            const statusText = document.getElementById(`${uiServiceName}-status-text`);
            const startBtn = document.getElementById(`start-${uiServiceName}-btn`);
            const stopBtn = document.getElementById(`stop-${uiServiceName}-btn`);
            const restartBtn = document.getElementById(`restart-${uiServiceName}-btn`);

            if (statusIndicator && statusText) {
                if (status === 'running') {
                    statusIndicator.className = 'status-running';
                    statusText.textContent = 'Running';
                    statusText.className = 'text-sm font-medium text-success';
                    if (startBtn) startBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                    if (restartBtn) restartBtn.disabled = false;
                } else {
                    statusIndicator.className = 'status-stopped';
                    statusText.textContent = 'Stopped';
                    statusText.className = 'text-sm font-medium text-destructive';
                    if (startBtn) startBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                    if (restartBtn) restartBtn.disabled = true;
                }
            }
        }

        async function viewServiceLogs(service) {
            try {
                const response = await fetch(`/admin/api/services/${service}/logs`);
                const result = await response.json();
                
                if (result.success) {
                    // Create a modern modal for logs
                    const logModal = document.createElement('div');
                    logModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                    logModal.innerHTML = `
                        <div class="card max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center p-6 border-b border-border">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
                                        <i data-lucide="file-text" class="w-4 h-4 text-primary"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-foreground">Service Logs</h3>
                                        <p class="text-sm text-muted-foreground">${service}</p>
                                    </div>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="btn-secondary w-8 h-8 p-0 rounded-full">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto bg-slate-950 text-green-400 p-6 font-mono text-sm">
                                <pre class="whitespace-pre-wrap">${result.logs || 'No logs available'}</pre>
                            </div>
                            
                            <div class="p-6 border-t border-border bg-muted/20">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-muted-foreground">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="folder" class="w-4 h-4"></i>
                                            <span>Log file: ${result.log_file || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button onclick="refreshServiceLogs('${service}', this.closest('.fixed'))" 
                                                class="btn-primary gap-2">
                                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                            Refresh
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="btn-secondary">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(logModal);
                    
                    // Initialize icons
                    setTimeout(() => lucide.createIcons(), 100);
                } else {
                    showToast(`Failed to get logs for ${service}: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error(`Error getting logs for ${service}:`, error);
                showToast(`Error getting logs for ${service}`, 'error');
            }
        }

        async function refreshServiceLogs(service, modal) {
            try {
                const response = await fetch(`/admin/api/services/${service}/logs`);
                const result = await response.json();
                
                if (result.success) {
                    const logsContainer = modal.querySelector('pre');
                    logsContainer.textContent = result.logs || 'No logs available';
                }
            } catch (error) {
                console.error(`Error refreshing logs for ${service}:`, error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Load configuration and services status
            loadConfiguration();
            loadServicesStatus();
        });
    </script>
</body>
</html>