<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS MCP - Admin Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 217.2 32.6% 17.5%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 142.1 76.2% 36.3%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 217.2 91.2% 59.8%;
            --radius: 0.5rem;
        }
        
        body {
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            transition: colors 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
            text-decoration: none;
            padding: 0.5rem 1rem;
            height: 2.5rem;
        }
        
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.9);
        }
        
        .btn-outline {
            border: 1px solid hsl(var(--border));
            background-color: transparent;
            color: hsl(var(--foreground));
        }
        
        .btn-outline:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .btn-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }
        
        .btn-destructive:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        /* Card Components */
        .card {
            border-radius: calc(var(--radius) + 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        .card-header {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            padding: 1.5rem;
        }
        
        .card-content {
            padding: 1.5rem;
            padding-top: 0;
        }
        
        .card-footer {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            padding-top: 0;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1;
            letter-spacing: -0.025em;
        }
        
        .card-description {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }
        
        /* Input Components */
        .input {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--input));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
            color: hsl(var(--foreground));
        }
        
        .input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring));
        }
        
        .input:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .input::placeholder {
            color: hsl(var(--muted-foreground));
        }
        
        /* Label Components */
        .label {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1;
            color: hsl(var(--foreground));
        }
        
        /* Form Groups */
        .form-group {
            display: grid;
            gap: 0.5rem;
        }
        
        .form-description {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }
        
        .form-error {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--destructive));
        }
        
        /* Accordion/Collapsible */
        .collapsible {
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 2px);
            background-color: hsl(var(--card));
        }
        
        .collapsible-trigger {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s;
            background: transparent;
            border: none;
            color: hsl(var(--foreground));
            cursor: pointer;
            text-align: left;
        }
        
        .collapsible-trigger:hover {
            text-decoration: underline;
        }
        
        .collapsible-content {
            overflow: hidden;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .collapsible-content[data-state="closed"] {
            animation: slide-up 0.3s ease-out;
        }
        
        .collapsible-content[data-state="open"] {
            animation: slide-down 0.3s ease-out;
        }
        
        @keyframes slide-down {
            from { height: 0; }
            to { height: var(--radix-collapsible-content-height); }
        }
        
        @keyframes slide-up {
            from { height: var(--radix-collapsible-content-height); }
            to { height: 0; }
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.125rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            transition: colors 0.2s;
        }
        
        .badge-default {
            border: 1px solid transparent;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .badge-secondary {
            border: 1px solid transparent;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .badge-destructive {
            border: 1px solid transparent;
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }
        
        .badge-outline {
            border: 1px solid hsl(var(--border));
            color: hsl(var(--foreground));
        }
        
        /* Loading Animation */
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Success/Error Messages */
        .alert {
            position: relative;
            width: 100%;
            border-radius: calc(var(--radius) + 2px);
            border: 1px solid hsl(var(--border));
            padding: 1rem;
            font-size: 0.875rem;
        }
        
        .alert-success {
            border-color: hsl(var(--secondary));
            background-color: hsl(var(--secondary) / 0.1);
            color: hsl(var(--secondary));
        }
        
        .alert-error {
            border-color: hsl(var(--destructive));
            background-color: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
        }
        
        /* Switch Component */
        .switch {
            position: relative;
            display: inline-flex;
            height: 1.5rem;
            width: 2.75rem;
            cursor: pointer;
            align-items: center;
            border-radius: 9999px;
            border: 2px solid transparent;
            transition: colors 0.2s;
            background-color: hsl(var(--input));
        }
        
        .switch[data-state="checked"] {
            background-color: hsl(var(--primary));
        }
        
        .switch-thumb {
            pointer-events: none;
            display: block;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 9999px;
            background-color: white;
            box-shadow: 0 2px 4px 0 rgb(0 0 0 / 0.2);
            transition: transform 0.2s;
            transform: translateX(0);
        }
        
        .switch[data-state="checked"] .switch-thumb {
            transform: translateX(1.25rem);
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <!-- Navigation -->
    <nav class="border-b border-gray-700 bg-gray-800/50 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-white">🛡️ LMS MCP Admin</h1>
                    </div>
                    <div class="ml-6">
                        <span class="text-sm" style="color: hsl(var(--muted-foreground))">Configuration Management</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="validateConfig()" class="btn btn-outline">
                        <i data-lucide="shield-check" class="w-4 h-4 mr-2"></i>
                        Validate
                    </button>
                    <button onclick="saveConfig()" class="btn btn-primary" id="saveBtn">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Save Changes
                    </button>
                    <a href="{{ url_for('main.landing') }}" class="btn btn-secondary">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Alert Messages -->
        <div id="alertContainer" class="mb-6 space-y-4 hidden"></div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading w-8 h-8 mx-auto mb-4">
                <i data-lucide="loader-2" class="w-8 h-8"></i>
            </div>
            <p style="color: hsl(var(--muted-foreground))">Loading configuration...</p>
        </div>

        <!-- Configuration Categories -->
        <div id="configContainer" class="space-y-6 hidden">
            <!-- Categories will be dynamically populated here -->
        </div>

        <!-- Footer Actions -->
        <div class="mt-8 flex justify-center space-x-4">
            <button onclick="resetToDefaults()" class="btn btn-destructive">
                <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>
                Reset to Defaults
            </button>
            <button onclick="exportConfig()" class="btn btn-outline">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Export Config
            </button>
        </div>
    </div>

    <script>
        let globalConfig = {};
        let hasUnsavedChanges = false;

        // Initialize Lucide icons
        lucide.createIcons();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
        });

        // Warn user about unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        async function loadConfiguration() {
            try {
                const response = await fetch('/admin/api/config');
                const data = await response.json();

                if (data.success) {
                    globalConfig = data.config;
                    renderConfiguration(data.config);
                    hideLoading();
                } else {
                    showAlert('Error loading configuration: ' + data.error, 'error');
                    hideLoading();
                }
            } catch (error) {
                showAlert('Failed to load configuration: ' + error.message, 'error');
                hideLoading();
            }
        }

        function renderConfiguration(config) {
            const container = document.getElementById('configContainer');
            container.innerHTML = '';

            Object.entries(config).forEach(([categoryId, category]) => {
                const categoryElement = createCategoryElement(categoryId, category);
                container.appendChild(categoryElement);
            });

            // Re-initialize icons for dynamically created content
            lucide.createIcons();
        }

        function createCategoryElement(categoryId, category) {
            const div = document.createElement('div');
            div.className = 'collapsible';
            
            const hasInvalidFields = Object.values(category.variables).some(variable => {
                const errors = validateVariable(variable.current_value || variable.default, variable);
                return errors.length > 0;
            });

            div.innerHTML = `
                <button class="collapsible-trigger" onclick="toggleCategory('${categoryId}')">
                    <div class="flex items-center">
                        <span class="text-lg">${category.name}</span>
                        ${hasInvalidFields ? '<span class="badge badge-destructive ml-2">Issues</span>' : ''}
                    </div>
                    <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200" id="chevron-${categoryId}"></i>
                </button>
                <div class="collapsible-content" id="content-${categoryId}" data-state="closed" style="height: 0; overflow: hidden;">
                    <div class="p-6 space-y-4">
                        <p class="text-sm text-gray-400 mb-4">${category.description}</p>
                        ${Object.entries(category.variables).map(([varName, variable]) => 
                            createVariableElement(categoryId, varName, variable)
                        ).join('')}
                    </div>
                </div>
            `;

            return div;
        }

        function createVariableElement(categoryId, varName, variable) {
            const currentValue = variable.current_value || variable.default;
            const errors = validateVariable(currentValue, variable);
            const hasErrors = errors.length > 0;

            let inputElement = '';
            switch (variable.type) {
                case 'boolean':
                    inputElement = `
                        <div class="flex items-center space-x-3">
                            <button class="switch" data-state="${currentValue === 'true' ? 'checked' : 'unchecked'}" 
                                    onclick="toggleSwitch('${categoryId}', '${varName}', this)">
                                <span class="switch-thumb"></span>
                            </button>
                            <span class="text-sm text-gray-400">${currentValue === 'true' ? 'Enabled' : 'Disabled'}</span>
                        </div>
                    `;
                    break;
                case 'password':
                    inputElement = `
                        <div class="relative">
                            <input type="password" id="${categoryId}-${varName}" class="input pr-10" 
                                   value="${currentValue}" 
                                   onchange="updateVariable('${categoryId}', '${varName}', this.value)"
                                   ${variable.required ? 'required' : ''}>
                            <button type="button" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300" 
                                    onclick="togglePasswordVisibility('${categoryId}-${varName}')">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    break;
                case 'number':
                    const min = variable.validation?.min || '';
                    const max = variable.validation?.max || '';
                    const step = variable.validation?.step || (variable.type === 'number' && variable.validation?.min >= 0 && variable.validation?.max <= 2 ? '0.1' : '1');
                    inputElement = `
                        <input type="number" id="${categoryId}-${varName}" class="input" 
                               value="${currentValue}" 
                               ${min !== '' ? `min="${min}"` : ''}
                               ${max !== '' ? `max="${max}"` : ''}
                               step="${step}"
                               onchange="updateVariable('${categoryId}', '${varName}', this.value)"
                               ${variable.required ? 'required' : ''}>
                    `;
                    break;
                default:
                    inputElement = `
                        <input type="text" id="${categoryId}-${varName}" class="input" 
                               value="${currentValue}" 
                               onchange="updateVariable('${categoryId}', '${varName}', this.value)"
                               ${variable.required ? 'required' : ''}>
                    `;
            }

            return `
                <div class="form-group">
                    <div class="flex items-center justify-between">
                        <label class="label" for="${categoryId}-${varName}">
                            ${varName}
                            ${variable.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                        </label>
                        ${currentValue !== variable.default ? '<span class="badge badge-secondary">Modified</span>' : ''}
                    </div>
                    ${inputElement}
                    <p class="form-description">${variable.description}</p>
                    ${hasErrors ? `<div class="form-error">${errors.join(', ')}</div>` : ''}
                </div>
            `;
        }

        function toggleCategory(categoryId) {
            const content = document.getElementById(`content-${categoryId}`);
            const chevron = document.getElementById(`chevron-${categoryId}`);
            
            if (content.dataset.state === 'closed') {
                content.dataset.state = 'open';
                content.style.height = 'auto';
                const height = content.scrollHeight;
                content.style.height = '0';
                requestAnimationFrame(() => {
                    content.style.height = height + 'px';
                });
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.dataset.state = 'closed';
                content.style.height = content.scrollHeight + 'px';
                requestAnimationFrame(() => {
                    content.style.height = '0';
                });
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function toggleSwitch(categoryId, varName, element) {
            const isChecked = element.dataset.state === 'checked';
            const newState = isChecked ? 'unchecked' : 'checked';
            const newValue = isChecked ? 'false' : 'true';
            
            element.dataset.state = newState;
            element.nextElementSibling.textContent = newValue === 'true' ? 'Enabled' : 'Disabled';
            
            updateVariable(categoryId, varName, newValue);
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        function updateVariable(categoryId, varName, value) {
            if (!globalConfig[categoryId]) {
                globalConfig[categoryId] = { variables: {} };
            }
            if (!globalConfig[categoryId].variables) {
                globalConfig[categoryId].variables = {};
            }
            
            globalConfig[categoryId].variables[varName] = {
                ...globalConfig[categoryId].variables[varName],
                current_value: value
            };
            
            hasUnsavedChanges = true;
            updateSaveButton();
        }

        function validateVariable(value, variable) {
            const errors = [];
            
            if (variable.required && (!value || value.trim() === '')) {
                errors.push('This field is required');
                return errors;
            }
            
            if (!value) return errors;
            
            const validation = variable.validation || {};
            
            switch (variable.type) {
                case 'number':
                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) {
                        errors.push('Must be a valid number');
                    } else {
                        if (validation.min !== undefined && numValue < validation.min) {
                            errors.push(`Must be at least ${validation.min}`);
                        }
                        if (validation.max !== undefined && numValue > validation.max) {
                            errors.push(`Must be at most ${validation.max}`);
                        }
                    }
                    break;
                case 'url':
                    if (!value.match(/^https?:\/\/.+/)) {
                        errors.push('Must be a valid URL');
                    }
                    break;
                case 'text':
                case 'password':
                    if (validation.min_length && value.length < validation.min_length) {
                        errors.push(`Must be at least ${validation.min_length} characters`);
                    }
                    if (validation.pattern && !new RegExp(validation.pattern).test(value)) {
                        errors.push('Invalid format');
                    }
                    break;
            }
            
            return errors;
        }

        async function saveConfig() {
            const saveBtn = document.getElementById('saveBtn');
            const originalContent = saveBtn.innerHTML;
            
            try {
                saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 loading"></i>Saving...';
                saveBtn.disabled = true;
                lucide.createIcons();

                const configToSave = {};
                Object.entries(globalConfig).forEach(([categoryId, category]) => {
                    configToSave[categoryId] = {};
                    Object.entries(category.variables || {}).forEach(([varName, variable]) => {
                        configToSave[categoryId][varName] = variable.current_value;
                    });
                });

                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ config: configToSave })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || 'Configuration saved successfully!', 'success');
                    hasUnsavedChanges = false;
                    updateSaveButton();
                } else {
                    showAlert('Error: ' + (data.errors ? data.errors.join(', ') : data.error), 'error');
                }
            } catch (error) {
                showAlert('Failed to save configuration: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
                lucide.createIcons();
            }
        }

        async function validateConfig() {
            try {
                const response = await fetch('/admin/api/validate');
                const data = await response.json();

                if (data.success) {
                    let totalErrors = 0;
                    Object.values(data.validation).forEach(category => {
                        Object.values(category).forEach(variable => {
                            if (!variable.valid) {
                                totalErrors += variable.errors.length;
                            }
                        });
                    });

                    if (totalErrors === 0) {
                        showAlert('✅ All configuration values are valid!', 'success');
                    } else {
                        showAlert(`⚠️ Found ${totalErrors} validation error(s). Please check the highlighted fields.`, 'error');
                        // Re-render with validation errors
                        loadConfiguration();
                    }
                } else {
                    showAlert('Error validating configuration: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Failed to validate configuration: ' + error.message, 'error');
            }
        }

        function resetToDefaults() {
            if (confirm('This will reset ALL configuration values to their defaults. Are you sure?')) {
                Object.entries(globalConfig).forEach(([categoryId, category]) => {
                    Object.entries(category.variables || {}).forEach(([varName, variable]) => {
                        globalConfig[categoryId].variables[varName].current_value = variable.default;
                    });
                });
                
                renderConfiguration(globalConfig);
                hasUnsavedChanges = true;
                updateSaveButton();
                showAlert('Configuration reset to defaults. Click Save to apply changes.', 'success');
            }
        }

        function exportConfig() {
            const configToExport = {};
            Object.entries(globalConfig).forEach(([categoryId, category]) => {
                Object.entries(category.variables || {}).forEach(([varName, variable]) => {
                    configToExport[varName] = variable.current_value || variable.default;
                });
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(configToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `lms-mcp-config-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-4 h-4 mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(alert);
            container.classList.remove('hidden');
            lucide.createIcons();

            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
                if (container.children.length === 0) {
                    container.classList.add('hidden');
                }
            }, 5000);
        }

        function updateSaveButton() {
            const saveBtn = document.getElementById('saveBtn');
            if (hasUnsavedChanges) {
                saveBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                saveBtn.classList.remove('btn-primary');
                saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4 mr-2"></i>Save Changes*';
            } else {
                saveBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                saveBtn.classList.add('btn-primary');
                saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4 mr-2"></i>Save Changes';
            }
            lucide.createIcons();
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('configContainer').classList.remove('hidden');
        }
    </script>
</body>
</html>