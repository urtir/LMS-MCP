<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="        /* Target all br tags in message content */
        #messages br {
            display: block;
            margin: 0.1em 0 !important;
            line-height: 0.1 !important;
        }
        
        /* Reduce overall line spacing in messages */
        #messages .text-sm {
            line-height: 1.2 !important;
        }
        
        /* More compact list spacing */
        #messages ul, #messages ol {
            margin: 0.5em 0 !important;
        }
        
        #messages li {
            margin-bottom: 0.1em !important;
        }rt" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat with Fas                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-950 text-white hover:bg-slate-800 h-12 px-4 gap-2">MCP - Session History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 84% 4.9%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 94.1%;
        }
        
        * {
            border-color: hsl(var(--border));
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        /* Collapsible content styles */
        .tool-content.collapsed {
            display: none;
        }

        .thinking-content.collapsed {
            display: none;
        }

        /* Custom scrollbar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: hsl(var(--muted));
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground));
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--foreground));
        }
        
        /* Reduced line break spacing - 75% less */
        .message-content br.leading-3 {
            display: block;
            margin: 0.0001em 0;
            line-height: 0.0001;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        /* Target all br tags in message content */
        #messages br {
            display: block;
            margin: 0.0002em 0 !important;
            line-height: 0.0002 !important;
        }
    </style>
</head>
<body class="bg-background text-foreground h-screen flex overflow-hidden">
    <!-- Sidebar for Session History -->
    <div id="sidebar" class="w-80 bg-card border-r border-border flex flex-col transition-all duration-300">
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-border">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-foreground flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    Chat History
                </h2>
                <div class="flex gap-2">
                    <button onclick="createNewSession()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-950 text-white hover:bg-slate-800 h-9 w-9">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                    <button onclick="toggleSidebar()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9">
                        <i data-lucide="sidebar-close" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <!-- Search Sessions -->
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"></i>
                <input type="text" id="searchSessions" placeholder="Search sessions..." class="flex h-10 w-full rounded-md border border-input bg-background px-10 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            </div>
        </div>
        
        <!-- Sessions List -->
        <div class="flex-1 overflow-hidden">
            <div id="sessionsList" class="h-full overflow-y-auto scrollbar-thin p-2 space-y-1">
                <!-- Sessions will be loaded here -->
            </div>
        </div>
        
        <!-- Sidebar Footer with Stats -->
        <div class="p-4 border-t border-border">
            <div class="text-xs text-muted-foreground space-y-1">
                <div class="flex justify-between">
                    <span>Total Sessions:</span>
                    <span id="totalSessions">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Total Messages:</span>
                    <span id="totalMessages">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-card border-b border-border p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" id="sidebarToggle" class="md:hidden inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9">
                        <i data-lucide="sidebar-open" class="w-4 h-4"></i>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-foreground" id="currentSessionTitle">New Chat</h1>
                        <p class="text-sm text-muted-foreground">LLM Chat powered by FastMCP</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="statusIndicator" class="flex items-center gap-2 text-sm">
                        <div class="w-2 h-2 rounded-full bg-muted animate-pulse" id="statusDot"></div>
                        <span class="text-muted-foreground" id="statusText">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="flex-1 overflow-hidden">
            <div id="messagesContainer" class="h-full overflow-y-auto scrollbar-thin">
                <div id="messages" class="w-full p-4 space-y-4">
                    <!-- Messages will appear here -->
                </div>
            </div>
        </div>

        <!-- Chat Input Area -->
        <div class="border-t border-border bg-card p-4">
            <div class="w-full">
                <div class="flex gap-3 items-end">
                    <div class="flex-1 relative">
                        <textarea
                            id="messageInput"
                            placeholder="Type your message here..."
                            rows="3"
                            class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <button
                        id="sendButton"
                        onclick="sendMessage()"
                        disabled
                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-12 px-4 gap-2"
                    >
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Send
                    </button>
                </div>
                <div class="mt-2 text-xs text-muted-foreground">
                    Press Shift+Enter for new line, Enter to send
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let isLoading = false;
        let sidebarVisible = true;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            loadSessions();
            loadStats();
            
            // Setup search
            document.getElementById('searchSessions').addEventListener('input', debounce(searchSessions, 300));
            
            // Setup message input
            const input = document.getElementById('messageInput');
            input.addEventListener('input', function() {
                document.getElementById('sendButton').disabled = this.value.trim() === '';
            });
            
            // Initialize icons
            lucide.createIcons();
        });

        // Session Management
        async function createNewSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                if (data.session_id) {
                    currentSessionId = data.session_id;
                    document.getElementById('currentSessionTitle').textContent = 'New Chat';
                    clearMessages();
                    loadSessions(); // Refresh session list
                    loadStats(); // Refresh stats
                }
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                sessionsList.innerHTML = '';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });
                } else {
                    sessionsList.innerHTML = '<div class="text-center text-muted-foreground py-8">No chat sessions yet. Start a new conversation!</div>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function createSessionElement(session) {
            const div = document.createElement('div');
            div.className = `group flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors hover:bg-accent ${currentSessionId === session.id ? 'bg-accent' : ''}`;
            div.onclick = () => loadSession(session.id);
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="message-circle" class="w-4 h-4 text-slate-950"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm text-foreground truncate">${session.title}</div>
                    <div class="text-xs text-muted-foreground">
                        ${session.message_count} messages • ${formatDate(session.updated_at)}
                    </div>
                </div>
                <div class="opacity-0 group-hover:opacity-100 flex items-center gap-1">
                    <button onclick="event.stopPropagation(); renameSession('${session.id}', '${session.title}')" class="p-1 rounded hover:bg-muted transition-colors">
                        <i data-lucide="edit-2" class="w-3 h-3"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteSession('${session.id}')" class="p-1 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
            
            return div;
        }

        async function loadSession(sessionId) {
            try {
                currentSessionId = sessionId;
                clearMessages();
                
                const response = await fetch(`/api/sessions/${sessionId}`);
                const data = await response.json();
                
                if (data.session && data.messages) {
                    document.getElementById('currentSessionTitle').textContent = data.session.title;
                    
                    // Load messages
                    data.messages.forEach(message => {
                        if (message.role !== 'system') {
                            displayMessage(message.role, message.content, message.tools_used, message.thinking_process);
                        }
                    });
                    
                    // Scroll to bottom
                    scrollToBottom();
                }
                
                // Update session highlight
                loadSessions();
                
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        async function renameSession(sessionId, currentTitle) {
            const newTitle = prompt('Enter new session title:', currentTitle);
            if (newTitle && newTitle !== currentTitle) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: newTitle })
                    });
                    
                    if (response.ok) {
                        if (currentSessionId === sessionId) {
                            document.getElementById('currentSessionTitle').textContent = newTitle;
                        }
                        loadSessions(); // Refresh session list
                    }
                } catch (error) {
                    console.error('Error renaming session:', error);
                }
            }
        }

        async function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        if (currentSessionId === sessionId) {
                            currentSessionId = null;
                            document.getElementById('currentSessionTitle').textContent = 'Select a chat session';
                            clearMessages();
                        }
                        loadSessions(); // Refresh session list
                        loadStats(); // Refresh stats
                    }
                } catch (error) {
                    console.error('Error deleting session:', error);
                }
            }
        }

        async function searchSessions() {
            const query = document.getElementById('searchSessions').value.trim();
            if (!query) {
                loadSessions();
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                sessionsList.innerHTML = '';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });
                } else {
                    sessionsList.innerHTML = '<div class="text-center text-muted-foreground py-8">No sessions found matching your search.</div>';
                }
            } catch (error) {
                console.error('Error searching sessions:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalSessions').textContent = data.total_sessions || 0;
                document.getElementById('totalMessages').textContent = data.total_messages || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Chat functionality (keeping existing functions but updating for session support)
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            // Create session if none exists
            if (!currentSessionId) {
                await createNewSession();
            }
            
            isLoading = true;
            input.value = '';
            document.getElementById('sendButton').disabled = true;
            
            // Display user message
            displayMessage('user', message);
            scrollToBottom();
            
            // Show loading indicator
            const loadingId = 'loading-' + Date.now();
            displayMessage('assistant', '', [], null, loadingId, true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (data.error) {
                    displayMessage('assistant', `Error: ${data.error}`, [], null, null, false, true);
                } else {
                    displayMessage('assistant', data.response, data.tool_calls, data.thinking);
                    
                    // Update session in sidebar if this was a new session
                    if (data.session_id && data.session_id !== currentSessionId) {
                        currentSessionId = data.session_id;
                        loadSessions();
                        loadStats();
                    }
                }
                
                scrollToBottom();
                
            } catch (error) {
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                console.error('Error:', error);
                displayMessage('assistant', `Error: ${error.message}`, [], null, null, false, true);
                scrollToBottom();
            }
            
            isLoading = false;
        }

        // Keep existing display functions but update for session support
        function displayMessage(role, content, toolCalls = [], thinking = null, messageId = null, isLoading = false, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            if (messageId) {
                messageDiv.id = messageId;
            }
            
            // Full width container for proper spacing
            messageDiv.className = `w-full flex gap-3 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex flex-col gap-2 max-w-[80%]">
                        <div class="rounded-2xl bg-slate-950 text-white px-4 py-3 shadow-sm">
                            <div class="text-sm">
                                ${markdownToHTML(content)}
                            </div>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-slate-950 text-white flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                `;
            } else {
                let messageContent = '';
                
                if (isLoading) {
                    messageContent = `
                        <div class="rounded-2xl bg-card border border-border px-4 py-3 shadow-sm">
                            <div class="flex items-center gap-3 text-muted-foreground">
                                <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-sm">AI is thinking...</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Container for all assistant content
                    let contentSections = [];
                    
                    // Thinking section
                    if (thinking) {
                        contentSections.push(createThinkingSection(thinking));
                    }
                    
                    // Tool calls section
                    if (toolCalls && toolCalls.length > 0) {
                        toolCalls.forEach((tool, index) => {
                            const toolId = `tool-${Date.now()}-${index}`;
                            contentSections.push(`
                                <div class="border border-border rounded-lg overflow-hidden mb-2 transition-all hover:border-primary/50 hover:shadow-md">
                                    <div class="bg-slate-950 text-white px-4 py-3 cursor-pointer flex items-center gap-2 hover:bg-slate-800 transition-colors" onclick="toggleTool('${toolId}')">
                                        <i data-lucide="wrench" class="w-4 h-4 flex-shrink-0"></i>
                                        <span class="font-medium flex-1 text-sm">🔧 Executed: ${tool.name}</span>
                                        <i id="${toolId}-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                                    </div>
                                    <div id="${toolId}" class="tool-content collapsed bg-card border-t border-border p-4">
                                        <div class="space-y-3">
                                            <div>
                                                <h4 class="text-sm font-semibold mb-2 text-foreground">Parameters:</h4>
                                                <div class="bg-muted rounded-md p-3 border">
                                                    <pre class="text-xs text-muted-foreground overflow-x-auto">${JSON.stringify(tool.arguments, null, 2)}</pre>
                                                </div>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold mb-2 text-foreground">Result:</h4>
                                                <div class="bg-muted rounded-md p-3 max-h-48 overflow-y-auto border">
                                                    <pre class="text-xs whitespace-pre-wrap text-muted-foreground">${JSON.stringify(tool.result, null, 2)}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    }
                    
                    // Main message content
                    if (content) {
                        const bgClass = isError ? 'bg-destructive/10 border-destructive/20' : 'bg-card border-border';
                        const textClass = isError ? 'text-destructive' : 'text-card-foreground';
                        
                        contentSections.push(`
                            <div class="rounded-2xl border ${bgClass} px-4 py-3 shadow-sm">
                                <div class="text-sm ${textClass}">
                                    ${markdownToHTML(content)}
                                </div>
                            </div>
                        `);
                    }
                    
                    messageContent = `<div class="space-y-2">${contentSections.join('')}</div>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-muted text-muted-foreground flex items-center justify-center flex-shrink-0 shadow-sm border border-border">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 max-w-none">
                        ${messageContent}
                    </div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            lucide.createIcons();
        }

        function createThinkingSection(thinking) {
            const thinkingId = 'thinking-' + Date.now();
            return `
                <div class="border border-border rounded-lg overflow-hidden mb-2 transition-all hover:border-primary/50 hover:shadow-md">
                    <div class="bg-muted text-muted-foreground px-4 py-3 cursor-pointer flex items-center gap-2 hover:bg-muted/80 transition-colors" onclick="toggleThinking('${thinkingId}')">
                        <i data-lucide="brain" class="w-4 h-4 flex-shrink-0"></i>
                        <span class="font-medium flex-1 text-sm">🤔 Thinking Process</span>
                        <i id="${thinkingId}-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                    </div>
                    <div id="${thinkingId}" class="thinking-content collapsed bg-card border-t border-border p-4">
                        <div class="text-sm text-foreground">
${thinking}
                        </div>
                    </div>
                </div>
            `;
        }

        // UI utility functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarVisible = !sidebarVisible;
            
            if (sidebarVisible) {
                sidebar.classList.remove('-translate-x-full', 'w-0');
                sidebar.classList.add('w-80');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('w-80');
                sidebar.classList.add('w-0');
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Keep existing utility functions
        function toggleTool(toolId) {
            const content = document.getElementById(toolId);
            const icon = document.getElementById(toolId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleThinking(thinkingId) {
            const content = document.getElementById(thinkingId);
            const icon = document.getElementById(thinkingId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Keep existing markdown and utility functions
        function markdownToHTML(text) {
            return formatMessage(text);
        }

        function formatMessage(content) {
            // Extract thinking sections first
            const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
            let processedText = content;
            const thinkingSections = [];
            
            let match;
            while ((match = thinkRegex.exec(content)) !== null) {
                thinkingSections.push(match[1].trim());
                processedText = processedText.replace(match[0], `__THINKING_PLACEHOLDER_${thinkingSections.length - 1}__`);
            }
            
            // Enhanced markdown formatting
            processedText = processedText
                // Code blocks with language detection
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang ? `<span class="code-lang text-xs bg-slate-950 text-white px-2 py-1 rounded-t-md">${lang}</span>` : '';
                    return `<div class="code-block bg-muted border rounded-md my-2 overflow-hidden">${language}<div class="p-3"><pre class="text-sm overflow-x-auto"><code>${escapeHtml(code.trim())}</code></pre></div></div>`;
                })
                // Regular code blocks
                .replace(/```([\s\S]*?)```/g, '<div class="code-block bg-muted border rounded-md p-3 my-2 overflow-x-auto"><pre class="text-sm"><code>$1</code></pre></div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code class="bg-muted text-muted-foreground px-2 py-1 rounded text-xs font-mono">$1</code>')
                // Headers
                .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>')
                // Horizontal rules
                .replace(/^---+$/gm, '<hr class="my-4 border-border">')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                // Line breaks first (before lists)
                .replace(/\n/g, '<br>')
                // Lists - unordered
                .replace(/^- (.*)$/gm, '<li class="list-item-bullet">$1</li>')
                // Lists - ordered (remove the number and dot)
                .replace(/^\d+\. (.*)$/gm, '<li class="list-item-number">$1</li>');
            
            // Wrap consecutive list items in proper containers
            processedText = processedText.replace(/(<li class="list-item-bullet"[^>]*>.*?<\/li>)(<br><li class="list-item-bullet"[^>]*>.*?<\/li>)*/g, function(match) {
                return '<ul class="my-1 space-y-0 list-disc pl-6">' + match.replace(/<br>/g, '').replace(/class="list-item-bullet"/g, 'class="mb-0"') + '</ul>';
            });
            
            processedText = processedText.replace(/(<li class="list-item-number"[^>]*>.*?<\/li>)(<br><li class="list-item-number"[^>]*>.*?<\/li>)*/g, function(match) {
                return '<ol class="my-1 space-y-0 list-decimal pl-6">' + match.replace(/<br>/g, '').replace(/class="list-item-number"/g, 'class="mb-0"') + '</ol>';
            });
            
            // Replace thinking placeholders with collapsible sections
            thinkingSections.forEach((thinking, index) => {
                const thinkingId = 'thinking-auto-' + Date.now() + '-' + index;
                const thinkingHtml = `
                    <div class="border border-border rounded-lg overflow-hidden mb-2 transition-all hover:border-primary hover:shadow-sm">
                        <div class="bg-muted text-muted-foreground px-4 py-3 cursor-pointer flex items-center gap-2 hover:bg-muted/80 transition-colors" onclick="toggleThinking('${thinkingId}')">
                            <i data-lucide="brain" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="font-medium flex-1 text-sm">🤔 Thinking Process</span>
                            <i id="${thinkingId}-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </div>
                        <div id="${thinkingId}" class="thinking-content collapsed bg-card border-t border-border p-4">
                            <div class="prose prose-sm max-w-none text-foreground">
                                ${formatMessage(thinking)}
                            </div>
                        </div>
                    </div>
                `;
                processedText = processedText.replace(`__THINKING_PLACEHOLDER_${index}__`, thinkingHtml);
            });
            
            return processedText;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                const lmStudioOk = data.lm_studio === 'connected';
                const fastmcpOk = data.fastmcp === 'connected';
                
                if (lmStudioOk && fastmcpOk) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    statusText.textContent = 'All systems operational';
                    statusText.className = 'text-green-600';
                } else if (lmStudioOk || fastmcpOk) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500';
                    statusText.textContent = 'Partial connectivity';
                    statusText.className = 'text-yellow-600';
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                    statusText.textContent = 'Connection issues';
                    statusText.className = 'text-red-600';
                }
                
                document.getElementById('sendButton').disabled = !lmStudioOk || document.getElementById('messageInput').value.trim() === '';
                
            } catch (error) {
                console.error('Status check failed:', error);
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Connection failed';
                statusText.className = 'text-red-600';
                
                document.getElementById('sendButton').disabled = true;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return 'Today';
            } else if (diffDays === 2) {
                return 'Yesterday';
            } else if (diffDays <= 7) {
                return `${diffDays - 1} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Periodic status check
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
