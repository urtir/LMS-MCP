<!DOCTYPE html>
<html lang="en" class="h-full w-full">
<head>
    <meta charset="UTF-8">
    <meta name="        /* Target all br tags in message content */
        #messages br {
            display: block;
            margin: 0.1em 0 !important;
            line-height: 0.1 !important;
        }
        
        /* Reduce overall line spacing in messages */
        #messages .text-sm {
            line-height: 1.1 !important;
        }
        
        /* Make all text in messages more compact */
        #messages div {
            line-height: 1.1;
        }
        
        #messages p {
            margin: 0.1em 0;
            line-height: 1.1;
        }
        
        /* More compact list spacing */
        #messages ul, #messages ol {
            margin: 0.5em 0 !important;
        }
        
        #messages li {
            margin-bottom: 0.1em !important;
        }
        
        /* Sidebar specific styles */
        .sidebar {
            background-color: hsl(var(--sidebar-background));
            color: hsl(var(--sidebar-foreground));
        }
        
        .sidebar[data-state="closed"] {
            width: 0 !important;
            min-width: 0 !important;
            opacity: 0;
            pointer-events: none;
            border-right: none;
        }
        
        .sidebar[data-state="open"] {
            width: 16rem !important;
            min-width: 16rem !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            display: flex !important;
        }
        
        .sidebar-content {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Ensure main content doesn't overflow */
        .sidebar-inset {
            min-width: 0;
            flex: 1;
            overflow: hidden;
        }
        
        /* Prevent text overflow in sidebar */
        .sidebar-title {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Prevent horizontal overflow */
        .sidebar-provider {
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        /* Ensure message content doesn't overflow */
        #messages {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        /* Fix any pre/code blocks that might overflow */
        pre, code {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* Ensure message content doesn't cause horizontal scroll */
        .message-content, .prose {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Ensure all containers respect viewport */
        * {
            box-sizing: border-box;
        }
        
        .sidebar-header {
            border-bottom: 1px solid hsl(var(--sidebar-border));
        }
        
        .sidebar-footer {
            border-top: 1px solid hsl(var(--sidebar-border));
        }
        
        .sidebar-menu-item {
            background-color: transparent;
        }
        
        .sidebar-menu-item:hover {
            background-color: hsl(var(--sidebar-accent));
            color: hsl(var(--sidebar-accent-foreground));
        }
        
        .sidebar-menu-item[data-active="true"] {
            background-color: hsl(var(--sidebar-accent));
            color: hsl(var(--sidebar-accent-foreground));
            font-weight: 500;
        }rt" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat with Fas                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-950 text-white hover:bg-slate-800 h-12 px-4 gap-2">MCP - Session History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 84% 4.9%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
            --sidebar-background: 0 0% 98%;
            --sidebar-foreground: 240 5.3% 26.1%;
            --sidebar-primary: 240 5.9% 10%;
            --sidebar-primary-foreground: 0 0% 98%;
            --sidebar-accent: 240 4.8% 95.9%;
            --sidebar-accent-foreground: 240 5.9% 10%;
            --sidebar-border: 220 13% 91%;
            --sidebar-ring: 217.2 10.6% 64.9%;
        }
        
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 94.1%;
        }
        
        * {
            border-color: hsl(var(--border));
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Collapsible content styles */
        .tool-content.collapsed {
            display: none;
        }

        .thinking-content.collapsed {
            display: none;
        }

        /* Custom scrollbar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: hsl(var(--muted));
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground));
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--foreground));
        }
        
        /* Reduced line break spacing - 75% less */
        .message-content br.leading-3 {
            display: block;
            margin: 0.0001em 0;
            line-height: 0.0001;
        }
        
        .message-content {
            line-height: 1.1;
        }
        
        /* Target all br tags in message content */
        #messages br {
            display: block;
            margin: 0.00002em 0 !important;
            line-height: 0.00002 !important;
            font-size: 0.01em !important;
            height: 0.01em !important;
        }
    </style>
</head>
<body class="bg-background text-foreground h-screen flex overflow-hidden">
    <!-- Sidebar Provider Pattern -->
    <div class="sidebar-provider flex w-full h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar relative flex h-full flex-col border-r bg-sidebar transition-all duration-300 ease-in-out flex-shrink-0" data-state="open" style="width: 16rem; min-width: 16rem;">
            <!-- Sidebar Header -->
            <div class="sidebar-header flex flex-col gap-3 p-4">
                <!-- Title and Buttons Row -->
                <div class="flex items-center justify-between min-h-[2rem]">
                    <h2 class="sidebar-title text-base font-semibold flex items-center gap-2 flex-1 min-w-0">
                        <i data-lucide="history" class="w-4 h-4 flex-shrink-0"></i>
                        <span class="truncate">Chat History</span>
                    </h2>
                    <div class="flex gap-1 flex-shrink-0 ml-2">
                        <button onclick="createNewSession()" title="New Chat" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-7 w-7">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                        </button>
                        <button onclick="toggleSidebar()" title="Close Sidebar" class="sidebar-trigger inline-flex items-center justify-center whitespace-nowrap rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7">
                            <i data-lucide="panel-left-close" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Search Sessions -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"></i>
                    <input type="text" id="searchSessions" placeholder="Search sessions..." class="flex h-9 w-full rounded-md border border-input bg-background px-10 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content flex-1 overflow-hidden">
                <nav class="sidebar-nav grid gap-1 p-2">
                    <div id="sessionsList" class="sidebar-group">
                        <!-- Sessions will be loaded here -->
                    </div>
                </nav>
            </div>
            
            <!-- Sidebar Footer with Stats -->
            <div class="sidebar-footer p-4 border-t">
                <div class="text-xs text-muted-foreground space-y-1">
                    <div class="flex justify-between">
                        <span>Total Sessions:</span>
                        <span id="totalSessions">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Messages:</span>
                        <span id="totalMessages">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area - SidebarInset -->
        <main class="sidebar-inset flex flex-1 flex-col min-w-0 overflow-hidden">
            <!-- Chat Header -->
            <header class="sidebar-header flex h-16 shrink-0 items-center gap-2 border-b bg-background px-4">
                <button onclick="toggleSidebar()" id="sidebarToggle" class="sidebar-trigger inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8">
                    <i data-lucide="panel-left-open" class="w-4 h-4"></i>
                </button>
                <div class="flex-1">
                    <h1 class="text-xl font-semibold" id="currentSessionTitle">New Chat</h1>
                    <p class="text-sm text-muted-foreground">LLM Chat powered by FastMCP</p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="statusIndicator" class="flex items-center gap-2 text-sm">
                        <div class="w-2 h-2 rounded-full bg-muted animate-pulse" id="statusDot"></div>
                        <span class="text-muted-foreground" id="statusText">Checking...</span>
                    </div>
                </div>
            </header>

        <!-- Chat Messages Area -->
        <div class="flex-1 overflow-hidden">
            <div id="messagesContainer" class="h-full overflow-y-auto overflow-x-hidden scrollbar-thin">
                <div id="messages" class="w-full max-w-full space-y-4 p-4">
                    <!-- Messages will appear here -->
                </div>
            </div>
        </div>

            <!-- Chat Input Area -->
            <div class="border-t bg-background p-4">
                <form class="relative" onsubmit="event.preventDefault(); sendMessage();">
                    <div class="flex gap-3 items-end">
                        <div class="flex-1 relative">
                            <textarea
                                id="messageInput"
                                placeholder="Type your message here..."
                                rows="3"
                                class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none"
                                onkeydown="handleKeyDown(event)"
                            ></textarea>
                        </div>
                        <button
                            type="submit"
                            id="sendButton"
                            disabled
                            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-12 px-4 py-2 gap-2"
                        >
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Send
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-muted-foreground">
                        Press Shift+Enter for new line, Enter to send
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let isLoading = false;
        let sidebarVisible = true;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            loadSessions();
            loadStats();
            
            // Setup search
            document.getElementById('searchSessions').addEventListener('input', debounce(searchSessions, 300));
            
            // Setup message input
            const input = document.getElementById('messageInput');
            input.addEventListener('input', function() {
                document.getElementById('sendButton').disabled = this.value.trim() === '';
            });
            
            // Initialize icons
            lucide.createIcons();
        });

        // Session Management
        async function createNewSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                if (data.session_id) {
                    currentSessionId = data.session_id;
                    document.getElementById('currentSessionTitle').textContent = 'New Chat';
                    clearMessages();
                    loadSessions(); // Refresh session list
                    loadStats(); // Refresh stats
                }
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                sessionsList.innerHTML = '';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });
                } else {
                    sessionsList.innerHTML = '<div class="text-center text-muted-foreground py-8">No chat sessions yet. Start a new conversation!</div>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function createSessionElement(session) {
            const div = document.createElement('div');
            div.className = `sidebar-menu-item group relative flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground cursor-pointer ${currentSessionId === session.id ? 'bg-sidebar-accent text-sidebar-accent-foreground font-medium' : ''}`;
            div.onclick = () => loadSession(session.id);
            
            div.innerHTML = `
                <div class="flex aspect-square size-8 items-center justify-center rounded-lg bg-sidebar-primary text-sidebar-primary-foreground">
                    <i data-lucide="message-circle" class="size-4"></i>
                </div>
                <div class="grid flex-1 text-left text-sm leading-tight">
                    <span class="truncate font-semibold">${session.title}</span>
                    <span class="truncate text-xs text-sidebar-foreground/70">${session.message_count} messages â€¢ ${formatDate(session.updated_at)}</span>
                </div>
                <div class="sidebar-menu-action absolute right-1 top-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); renameSession('${session.id}', '${session.title}')" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-6 w-6">
                            <i data-lucide="edit-2" class="size-3"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteSession('${session.id}')" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-destructive hover:text-destructive-foreground h-6 w-6">
                            <i data-lucide="trash-2" class="size-3"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        async function loadSession(sessionId) {
            try {
                currentSessionId = sessionId;
                clearMessages();
                
                const response = await fetch(`/api/sessions/${sessionId}`);
                const data = await response.json();
                
                if (data.session && data.messages) {
                    document.getElementById('currentSessionTitle').textContent = data.session.title;
                    
                    // Load messages
                    data.messages.forEach(message => {
                        if (message.role !== 'system') {
                            displayMessage(message.role, message.content, message.tools_used, message.thinking_process);
                        }
                    });
                    
                    // Scroll to bottom
                    scrollToBottom();
                }
                
                // Update session highlight
                loadSessions();
                
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        async function renameSession(sessionId, currentTitle) {
            const newTitle = prompt('Enter new session title:', currentTitle);
            if (newTitle && newTitle !== currentTitle) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: newTitle })
                    });
                    
                    if (response.ok) {
                        if (currentSessionId === sessionId) {
                            document.getElementById('currentSessionTitle').textContent = newTitle;
                        }
                        loadSessions(); // Refresh session list
                    }
                } catch (error) {
                    console.error('Error renaming session:', error);
                }
            }
        }

        async function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        if (currentSessionId === sessionId) {
                            currentSessionId = null;
                            document.getElementById('currentSessionTitle').textContent = 'Select a chat session';
                            clearMessages();
                        }
                        loadSessions(); // Refresh session list
                        loadStats(); // Refresh stats
                    }
                } catch (error) {
                    console.error('Error deleting session:', error);
                }
            }
        }

        async function searchSessions() {
            const query = document.getElementById('searchSessions').value.trim();
            if (!query) {
                loadSessions();
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                sessionsList.innerHTML = '';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });
                } else {
                    sessionsList.innerHTML = '<div class="text-center text-muted-foreground py-8">No sessions found matching your search.</div>';
                }
            } catch (error) {
                console.error('Error searching sessions:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalSessions').textContent = data.total_sessions || 0;
                document.getElementById('totalMessages').textContent = data.total_messages || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Chat functionality (keeping existing functions but updating for session support)
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            // Create session if none exists
            if (!currentSessionId) {
                await createNewSession();
            }
            
            isLoading = true;
            input.value = '';
            document.getElementById('sendButton').disabled = true;
            
            // Display user message
            displayMessage('user', message);
            scrollToBottom();
            
            // Show loading indicator
            const loadingId = 'loading-' + Date.now();
            displayMessage('assistant', '', [], null, loadingId, true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (data.error) {
                    displayMessage('assistant', `Error: ${data.error}`, [], null, null, false, true);
                } else {
                    displayMessage('assistant', data.response, data.tool_calls, data.thinking);
                    
                    // Update session in sidebar if this was a new session
                    if (data.session_id && data.session_id !== currentSessionId) {
                        currentSessionId = data.session_id;
                        loadSessions();
                        loadStats();
                    }
                }
                
                scrollToBottom();
                
            } catch (error) {
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                console.error('Error:', error);
                displayMessage('assistant', `Error: ${error.message}`, [], null, null, false, true);
                scrollToBottom();
            }
            
            isLoading = false;
        }

        // Keep existing display functions but update for session support
        function displayMessage(role, content, toolCalls = [], thinking = null, messageId = null, isLoading = false, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            if (messageId) {
                messageDiv.id = messageId;
            }
            
            // Full width container for proper spacing with padding
            messageDiv.className = `w-full flex gap-3 px-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex flex-col gap-2 max-w-[80%]">
                        <div class="rounded-2xl bg-slate-950 text-white px-4 py-3 shadow-sm">
                            <div class="text-sm">
                                ${markdownToHTML(content)}
                            </div>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-slate-950 text-white flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                `;
            } else {
                let messageContent = '';
                
                if (isLoading) {
                    messageContent = `
                        <div class="rounded-2xl bg-card border border-border px-4 py-3 shadow-sm">
                            <div class="flex items-center gap-3 text-muted-foreground">
                                <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-sm">AI is thinking...</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Container for all assistant content
                    let contentSections = [];
                    
                    // Thinking section
                    if (thinking) {
                        contentSections.push(createThinkingSection(thinking));
                    }
                    
                    // Tool calls section
                    if (toolCalls && toolCalls.length > 0) {
                        toolCalls.forEach((tool, index) => {
                            const toolId = `tool-${Date.now()}-${index}`;
                            contentSections.push(`
                                <div class="border border-border rounded-lg overflow-hidden mb-2 transition-all hover:border-primary/50 hover:shadow-md">
                                    <div class="bg-slate-950 text-white px-4 py-3 cursor-pointer flex items-center gap-2 hover:bg-slate-800 transition-colors" onclick="toggleTool('${toolId}')">
                                        <i data-lucide="wrench" class="w-4 h-4 flex-shrink-0"></i>
                                        <span class="font-medium flex-1 text-sm">ðŸ”§ Executed: ${tool.name}</span>
                                        <i id="${toolId}-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                                    </div>
                                    <div id="${toolId}" class="tool-content collapsed bg-card border-t border-border p-4">
                                        <div class="space-y-3">
                                            <div>
                                                <h4 class="text-sm font-semibold mb-2 text-foreground">Parameters:</h4>
                                                <div class="bg-muted rounded-md p-3 border">
                                                    <pre class="text-xs text-muted-foreground overflow-x-auto">${JSON.stringify(tool.arguments, null, 2)}</pre>
                                                </div>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold mb-2 text-foreground">Result:</h4>
                                                <div class="bg-muted rounded-md p-3 max-h-48 overflow-y-auto border">
                                                    <pre class="text-xs whitespace-pre-wrap text-muted-foreground">${JSON.stringify(tool.result, null, 2)}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    }
                    
                    // Main message content
                    if (content) {
                        const bgClass = isError ? 'bg-destructive/10 border-destructive/20' : 'bg-card border-border';
                        const textClass = isError ? 'text-destructive' : 'text-card-foreground';
                        
                        contentSections.push(`
                            <div class="rounded-2xl border ${bgClass} px-4 py-3 shadow-sm">
                                <div class="text-sm ${textClass}">
                                    ${markdownToHTML(content)}
                                </div>
                            </div>
                        `);
                    }
                    
                    messageContent = `<div class="space-y-2">${contentSections.join('')}</div>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-muted text-muted-foreground flex items-center justify-center flex-shrink-0 shadow-sm border border-border">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 min-w-0 max-w-full overflow-hidden">
                        ${messageContent}
                    </div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            lucide.createIcons();
        }

        function createThinkingSection(thinking) {
            const thinkingId = 'thinking-' + Date.now();
            return `
                <div class="collapsible rounded-lg border border-border" data-state="closed">
                    <button type="button" class="collapsible-trigger flex w-full items-center justify-between p-3 text-sm font-medium hover:bg-muted/50 focus:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 [&[data-state=open]>svg]:rotate-180" onclick="toggleThinking('${thinkingId}')">
                        <div class="flex items-center gap-2">
                            <i data-lucide="brain" class="h-4 w-4 text-muted-foreground"></i>
                            <span>ðŸ¤” Thinking Process</span>
                        </div>
                        <i id="${thinkingId}-icon" data-lucide="chevron-down" class="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200"></i>
                    </button>
                    <div id="${thinkingId}" class="collapsible-content overflow-hidden data-[state=closed]:animate-collapsible-up data-[state=open]:animate-collapsible-down" data-state="closed" style="height: 0;">
                        <div class="border-t p-4 pt-3">
                            <div class="text-sm text-muted-foreground whitespace-pre-wrap">
${thinking}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // UI utility functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isOpen = sidebar.getAttribute('data-state') === 'open';
            
            if (isOpen) {
                // Close sidebar
                sidebar.setAttribute('data-state', 'closed');
                sidebar.style.width = '0';
                sidebar.style.minWidth = '0';
                sidebar.style.opacity = '0';
                sidebar.style.pointerEvents = 'none';
                sidebar.style.borderRight = 'none';
            } else {
                // Open sidebar with fixed width
                sidebar.setAttribute('data-state', 'open');
                sidebar.style.width = '16rem';
                sidebar.style.minWidth = '16rem';
                sidebar.style.opacity = '1';
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.borderRight = '';
            }
            
            // Update trigger icons
            const triggers = document.querySelectorAll('.sidebar-trigger i');
            triggers.forEach(icon => {
                if (isOpen) {
                    icon.setAttribute('data-lucide', 'panel-left-open');
                } else {
                    icon.setAttribute('data-lucide', 'panel-left-close');
                }
            });
            
            // Reinitialize icons
            lucide.createIcons();
            sidebarVisible = !isOpen;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Keep existing utility functions
        function toggleTool(toolId) {
            const content = document.getElementById(toolId);
            const icon = document.getElementById(toolId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleThinking(thinkingId) {
            const content = document.getElementById(thinkingId);
            const icon = document.getElementById(thinkingId + '-icon');
            
            // Check if this is the new format (from formatMessage) or old format (from createThinkingSection)
            if (content.classList.contains('thinking-content')) {
                // New format - toggle collapsed class
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('collapsed');
                    icon.style.transform = 'rotate(0deg)';
                }
            } else {
                // Old format - toggle data-state and height
                const trigger = content.parentElement.querySelector('.collapsible-trigger');
                const isOpen = content.getAttribute('data-state') === 'open';
                
                if (isOpen) {
                    content.setAttribute('data-state', 'closed');
                    content.style.height = '0';
                    if (trigger) trigger.setAttribute('data-state', 'closed');
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.setAttribute('data-state', 'open');
                    content.style.height = 'auto';
                    if (trigger) trigger.setAttribute('data-state', 'open');
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        }

        // Keep existing markdown and utility functions
        function markdownToHTML(text) {
            return formatMessage(text);
        }

        function formatMessage(content) {
            // Extract thinking sections first
            const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
            let processedText = content;
            const thinkingSections = [];
            
            let match;
            while ((match = thinkRegex.exec(content)) !== null) {
                thinkingSections.push(match[1].trim());
                processedText = processedText.replace(match[0], `__THINKING_PLACEHOLDER_${thinkingSections.length - 1}__`);
            }
            
            // Enhanced markdown formatting
            processedText = processedText
                // Code blocks with language detection
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang ? `<span class="code-lang text-xs bg-slate-950 text-white px-2 py-1 rounded-t-md">${lang}</span>` : '';
                    return `<div class="code-block bg-muted border rounded-md my-2 overflow-hidden">${language}<div class="p-3"><pre class="text-sm overflow-x-auto"><code>${escapeHtml(code.trim())}</code></pre></div></div>`;
                })
                // Regular code blocks
                .replace(/```([\s\S]*?)```/g, '<div class="code-block bg-muted border rounded-md p-3 my-2 overflow-x-auto"><pre class="text-sm"><code>$1</code></pre></div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code class="bg-muted text-muted-foreground px-2 py-1 rounded text-xs font-mono">$1</code>')
                // Headers
                .replace(/^###### (.*$)/gm, '<h6 class="text-xs font-medium mt-2 mb-1">$1</h6>')
                .replace(/^##### (.*$)/gm, '<h5 class="text-sm font-medium mt-2 mb-1">$1</h5>')
                .replace(/^#### (.*$)/gm, '<h4 class="text-base font-semibold mt-3 mb-2">$1</h4>')
                .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>')
                // Horizontal rules
                .replace(/^---+$/gm, '<hr class="my-4 border-border">')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                // Line breaks with almost zero height
                .replace(/\n/g, '<span style="display: block; height: 2px; line-height: 2px; font-size: 1px;"></span>')
                // Lists - unordered
                .replace(/^- (.*)$/gm, '<li class="list-item-bullet">$1</li>')
                // Lists - ordered (remove the number and dot)
                .replace(/^\d+\. (.*)$/gm, '<li class="list-item-number">$1</li>');
            
            // Wrap consecutive list items in proper containers
            processedText = processedText.replace(/(<li class="list-item-bullet"[^>]*>.*?<\/li>)(<span[^>]*><\/span><li class="list-item-bullet"[^>]*>.*?<\/li>)*/g, function(match) {
                return '<ul class="my-1 space-y-0 list-disc pl-6">' + match.replace(/<span[^>]*><\/span>/g, '').replace(/class="list-item-bullet"/g, 'class="mb-0"') + '</ul>';
            });
            
            processedText = processedText.replace(/(<li class="list-item-number"[^>]*>.*?<\/li>)(<span[^>]*><\/span><li class="list-item-number"[^>]*>.*?<\/li>)*/g, function(match) {
                return '<ol class="my-1 space-y-0 list-decimal pl-6">' + match.replace(/<span[^>]*><\/span>/g, '').replace(/class="list-item-number"/g, 'class="mb-0"') + '</ol>';
            });
            
            // Replace thinking placeholders with collapsible sections
            thinkingSections.forEach((thinking, index) => {
                const thinkingId = 'thinking-auto-' + Date.now() + '-' + index;
                const thinkingHtml = `
                    <div class="border border-border rounded-lg overflow-hidden mb-2 transition-all hover:border-primary hover:shadow-sm">
                        <div class="bg-muted text-muted-foreground px-4 py-3 cursor-pointer flex items-center gap-2 hover:bg-muted/80 transition-colors" onclick="toggleThinking('${thinkingId}')">
                            <i data-lucide="brain" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="font-medium flex-1 text-sm">ðŸ¤” Thinking Process</span>
                            <i id="${thinkingId}-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </div>
                        <div id="${thinkingId}" class="thinking-content collapsed bg-card border-t border-border p-4">
                            <div class="prose prose-sm max-w-full overflow-hidden text-foreground">
                                ${formatMessage(thinking)}
                            </div>
                        </div>
                    </div>
                `;
                processedText = processedText.replace(`__THINKING_PLACEHOLDER_${index}__`, thinkingHtml);
            });
            
            return processedText;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                const lmStudioOk = data.lm_studio === 'connected';
                const fastmcpOk = data.fastmcp === 'connected';
                
                if (lmStudioOk && fastmcpOk) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    statusText.textContent = 'All systems operational';
                    statusText.className = 'text-green-600';
                } else if (lmStudioOk || fastmcpOk) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500';
                    statusText.textContent = 'Partial connectivity';
                    statusText.className = 'text-yellow-600';
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                    statusText.textContent = 'Connection issues';
                    statusText.className = 'text-red-600';
                }
                
                document.getElementById('sendButton').disabled = !lmStudioOk || document.getElementById('messageInput').value.trim() === '';
                
            } catch (error) {
                console.error('Status check failed:', error);
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Connection failed';
                statusText.className = 'text-red-600';
                
                document.getElementById('sendButton').disabled = true;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return 'Today';
            } else if (diffDays === 2) {
                return 'Yesterday';
            } else if (diffDays <= 7) {
                return `${diffDays - 1} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Periodic status check
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
